name: .NET Release

# This workflow runs when a tag matching the 'v*.*.*' pattern is pushed (e.g., v1.0.0)
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    name: Build and Release
    # We use the latest Ubuntu runner as it can build for all target platforms
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # Build the application for each target platform
      - name: Build project for each platform
        run: |
          # Extract the version number from the tag by removing the 'v' prefix using shell parameter expansion.
          # The GITHUB_REF_NAME environment variable is automatically provided by the runner.
          VERSION_NUMBER=${GITHUB_REF_NAME#v}
          for rid in win-x64 linux-x64 osx-x64; do
            # Publish the application, excluding debug symbols (PDB files) for a cleaner release.
            dotnet publish ./file_sort/file_sort.csproj --configuration Release --runtime $rid --output ./publish/$rid /p:Version=$VERSION_NUMBER /p:DebugType=None /p:DebugSymbols=false
          done

      # Package the results into versioned archives with the version at the end.
      - name: Create release archives
        run: |
          zip -j ./file_sort-win-x64-${GITHUB_REF_NAME}.zip ./publish/win-x64/*
          (cd ./publish/linux-x64 && tar -czvf ../../file_sort-linux-x64-${GITHUB_REF_NAME}.tar.gz *)
          (cd ./publish/osx-x64 && tar -czvf ../../file_sort-osx-x64-${GITHUB_REF_NAME}.tar.gz *)

      # Create a GitHub Release and upload the artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # The tag name will be used for the release
          tag_name: ${{ github.ref_name }}
          # The name of the release
          name: Release ${{ github.ref_name }}
          # Enable automatic generation of release notes based on commits
          generate_release_notes: true
          # Specify which files to attach to the release
          files: |
            ./file_sort-win-x64-${{ github.ref_name }}.zip
            ./file_sort-linux-x64-${{ github.ref_name }}.tar.gz
            ./file_sort-osx-x64-${{ github.ref_name }}.tar.gz